
Sub Extract_Jobs_To_Table()

    Dim wsIn As Worksheet, wsOut As Worksheet
    Dim lastRow As Long, outRow As Long
    Dim i As Long, lineTxt As String
    
    ' Job level variables
    Dim jobId As String, jobName As String
    Dim sourcePath As String, sourceServer As String
    Dim targetPath As String, targetServer As String
    Dim successEmail As String, failureEmail As String
    Dim frequency As String, remarks As String
    
    Dim loadCount As Long, uploadCount As Long
    
    Set wsIn = ActiveSheet
    
    ' Create / reset output sheet
    On Error Resume Next
    Set wsOut = ThisWorkbook.Worksheets("Output")
    On Error GoTo 0
    
    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Worksheets.Add
        wsOut.Name = "Output"
    Else
        wsOut.Cells.Clear
    End If
    
    ' Headers
    wsOut.Range("A1:J1").Value = Array("Job Id", "Job Name", "Source path", _
        "Source server name", "Target Path", "Target Server name", _
        "Success email", "Failure email", "Frequency", "Remarks")
    
    outRow = 2
    lastRow = wsIn.Cells(wsIn.Rows.Count, "A").End(xlUp).Row
    
    ' Initialize
    jobId = ""
    
    For i = 1 To lastRow
        lineTxt = Trim(wsIn.Cells(i, "A").Value)
        
        ' -------- JOB HEADER --------
        If InStr(lineTxt, "#") > 0 Then
            
            ' Write previous job
            If jobId <> "" Then
                Call WriteOutput(wsOut, outRow, jobId, jobName, sourcePath, _
                    sourceServer, targetPath, targetServer, successEmail, _
                    failureEmail, frequency, remarks)
                outRow = outRow + 1
            End If
            
            ' Reset variables
            sourcePath = "Not available"
            sourceServer = "Not available"
            targetPath = "Not available"
            targetServer = "Not available"
            successEmail = "Not available"
            failureEmail = "Not available"
            frequency = "Not available"
            remarks = ""
            loadCount = 0
            uploadCount = 0
            
            ' Extract Job Name & ID
            jobName = Trim(Left(lineTxt, InStr(lineTxt, "(#") - 1))
            jobId = Replace(Mid(lineTxt, InStr(lineTxt, "(#") + 2), ")", "")
        
        ' -------- LOAD --------
        ElseIf LCase(lineTxt) Like "load*" Then
            loadCount = loadCount + 1
            If loadCount = 1 Then
                sourcePath = Trim(Mid(lineTxt, 6, InStr(lineTxt, " from ") - 6))
                sourceServer = Trim(Mid(lineTxt, InStr(lineTxt, " from ") + 6))
            Else
                remarks = remarks & "Multiple Load found; "
            End If
        
        ' -------- UPLOAD --------
        ElseIf LCase(lineTxt) Like "upload*" Then
            uploadCount = uploadCount + 1
            If uploadCount = 1 Then
                targetPath = Trim(Mid(lineTxt, 10, InStr(lineTxt, " on ") - 10))
                targetServer = Trim(Mid(lineTxt, InStr(lineTxt, " on ") + 4))
            Else
                remarks = remarks & "Multiple Upload found; "
            End If
        
        ' -------- FREQUENCY --------
        ElseIf LCase(lineTxt) Like "run*" Then
            frequency = lineTxt
        
        ' -------- EMAIL --------
        ElseIf InStr(LCase(lineTxt), "send email") > 0 Then
            If InStr(LCase(lineTxt), "failure") > 0 Then
                failureEmail = ExtractEmail(lineTxt)
            ElseIf InStr(LCase(lineTxt), "success") > 0 Then
                successEmail = ExtractEmail(lineTxt)
            End If
        End If
    Next i
    
    ' Write last job
    If jobId <> "" Then
        Call WriteOutput(wsOut, outRow, jobId, jobName, sourcePath, _
            sourceServer, targetPath, targetServer, successEmail, _
            failureEmail, frequency, remarks)
    End If
    
    wsOut.Columns.AutoFit
    MsgBox "Job extraction completed successfully.", vbInformation

End Sub


' ---------------- HELPER: WRITE OUTPUT ----------------
Sub WriteOutput(ws As Worksheet, r As Long, jobId As String, jobName As String, _
    srcPath As String, srcServer As String, tgtPath As String, tgtServer As String, _
    succEmail As String, failEmail As String, freq As String, remarks As String)
    
    ws.Cells(r, 1).Value = jobId
    ws.Cells(r, 2).Value = jobName
    ws.Cells(r, 3).Value = srcPath
    ws.Cells(r, 4).Value = srcServer
    ws.Cells(r, 5).Value = tgtPath
    ws.Cells(r, 6).Value = tgtServer
    ws.Cells(r, 7).Value = succEmail
    ws.Cells(r, 8).Value = failEmail
    ws.Cells(r, 9).Value = freq
    ws.Cells(r, 10).Value = IIf(remarks = "", "Not available", remarks)
    
End Sub


' ---------------- HELPER: EMAIL EXTRACTOR ----------------
Function ExtractEmail(txt As String) As String
    Dim p1 As Long, p2 As Long
    p1 = InStr(txt, "'")
    p2 = InStr(p1 + 1, txt, "'")
    
    If p1 > 0 And p2 > p1 Then
        ExtractEmail = Mid(txt, p1 + 1, p2 - p1 - 1)
    Else
        ExtractEmail = "Not available"
    End If
End Function
